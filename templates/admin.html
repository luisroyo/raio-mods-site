<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - RAIO MODS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <header class="border-b-2 border-neon-cyan py-6 mb-8">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-4xl font-bold neon-cyan">Painel Admin</h1>
            <div class="flex gap-4 items-center">
                <button onclick="openConfigModal()" class="flex items-center gap-2 border border-yellow-500 text-yellow-500 px-3 py-1 rounded hover:bg-yellow-900 transition">
                    ‚öôÔ∏è Config Pagamentos
                </button>
                <a href="{{ url_for('public.index') }}" class="neon-purple hover:text-white">Ver Loja</a>
                <a href="{{ url_for('public.links') }}" class="neon-cyan hover:text-white">Ver Links</a>
                <a href="{{ url_for('admin.admin_logout') }}" class="text-red-400">Sair</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-12">
        <!-- Dashboard: contadores -->
        <div class="mb-8 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="border border-neon-cyan rounded-lg p-4 text-center bg-black/30">
                <div class="text-2xl md:text-3xl font-bold neon-cyan">{{ stats.total_products }}</div>
                <p class="text-xs md:text-sm text-gray-400 mt-1">Total de Produtos</p>
            </div>
            <div class="border border-neon-purple rounded-lg p-4 text-center bg-black/30">
                <div class="text-2xl md:text-3xl font-bold neon-purple">{{ stats.total_catalogs }}</div>
                <p class="text-xs md:text-sm text-gray-400 mt-1">Jogos (Capas)</p>
            </div>
            <div class="border border-neon-green rounded-lg p-4 text-center bg-black/30">
                <div class="text-2xl md:text-3xl font-bold neon-green">{{ stats.total_links }}</div>
                <p class="text-xs md:text-sm text-gray-400 mt-1">Links √öteis</p>
            </div>
            <div class="border border-yellow-500 rounded-lg p-4 text-center bg-black/30">
                <div class="text-2xl md:text-3xl font-bold text-yellow-500">{{ stats.total_simple }}</div>
                <p class="text-xs md:text-sm text-gray-400 mt-1">Produtos Soltos</p>
            </div>
        </div>

        <div class="mb-8 flex flex-wrap gap-4 border-b-2 border-neon-cyan pb-2">
            <button onclick="showSection('catalog')" id="tab-catalog" class="px-6 py-2 font-bold neon-cyan border-b-2 border-neon-cyan">üìÇ Jogos (Capas)</button>
            <button onclick="showSection('product')" id="tab-product" class="px-6 py-2 font-bold text-gray-400">üõçÔ∏è Produtos Soltos</button>
            <button onclick="showSection('links')" id="tab-links" class="px-6 py-2 font-bold text-gray-400">üîó Links √öteis</button>
        </div>

        <div id="section-catalog" class="section-content">
            <div class="mb-12 border-2 border-neon-purple rounded-lg p-8">
                <h2 class="text-2xl font-bold neon-purple mb-6">üìÇ Novo Jogo (Capa)</h2>
                <form id="addCatalogForm" class="space-y-4" data-url="{{ url_for('admin.add_product') }}">
                    <input type="hidden" name="is_catalog" value="1">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="name" required placeholder="Nome do Jogo" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                        <input type="text" name="category" required placeholder="Categoria" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                    </div>
                    <textarea name="description" required rows="2" placeholder="Descri√ß√£o da Capa" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white"></textarea>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="number" name="sort_order" value="0" placeholder="Ordem" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                        <input type="text" name="price" required placeholder="Chamada (Ex: A partir de R$ 10)" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                    </div>
                    <input type="file" name="image" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                    <input type="text" name="image_url" placeholder="Ou URL da imagem" class="w-full px-4 py-2 bg-black border border-neon-purple rounded text-white">
                    <button type="submit" class="w-full py-3 bg-neon-purple text-white font-bold rounded">‚ûï Criar Jogo</button>
                </form>
                <div id="catalog_message" class="mt-4 hidden"></div>
            </div>

            <div class="space-y-8">
                {% if catalogs %}
                {% for catalog in catalogs %}
                {% set subproducts = subproducts_by_parent.get(catalog.id, []) %}
                <div class="border border-neon-purple rounded-lg p-6 bg-gray-900 bg-opacity-30">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3 text-center">
                            <img src="{{ catalog.image }}" class="w-32 h-32 mx-auto rounded-full object-contain border-4 border-neon-purple mb-4">
                            <h3 class="text-2xl font-bold neon-purple">{{ catalog.name }}</h3>
                            <div class="flex gap-2 justify-center mt-4">
                                <button onclick='openEditModal({{ catalog.id }}, {{ catalog.name|tojson }}, {{ catalog.description|tojson }}, {{ catalog.price|tojson }}, {{ catalog.category|tojson }}, {{ catalog.image|tojson }}, "", {{ catalog.sort_order }}, null, 1, "")' class="px-4 py-2 bg-neon-purple text-white rounded hover:bg-opacity-80">Editar</button>
                                <button onclick='deleteProduct({{ catalog.id }})' class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Excluir</button>
                            </div>
                            <button onclick='openAddSubproductModal({{ catalog.id }}, {{ catalog.name|tojson }})' class="w-full mt-4 py-2 bg-green-600 text-black font-bold rounded hover:bg-green-500">‚ûï Add Produto Aqui</button>
                        </div>
                        <div class="md:w-2/3">
                            <h4 class="font-bold mb-4">Produtos em {{ catalog.name }}:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% for sub in subproducts %}
                                <div class="border border-neon-cyan p-4 rounded bg-black">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="font-bold text-neon-cyan block">{{ sub.name }}</span>
                                            <span class="text-green-400 text-sm">{{ sub.price }}</span>
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick='openEditModal({{ sub.id }}, {{ sub.name|tojson }}, {{ sub.description|tojson }}, {{ sub.price|tojson }}, {{ sub.category|tojson }}, {{ sub.image|tojson }}, {{ (sub.tagline|default(""))|tojson }}, {{ sub.sort_order }}, {{ sub.parent_id }}, 0, {{ (sub.payment_url|default(""))|tojson }})' class="text-xs bg-blue-600 px-2 py-1 rounded hover:bg-blue-500">‚úèÔ∏è</button>
                                            <button onclick='deleteProduct({{ sub.id }})' class="text-xs bg-red-600 px-2 py-1 rounded hover:bg-red-500">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="section-product" class="section-content hidden">
            <div class="mb-8 border-2 border-neon-cyan rounded-lg p-8">
                <h2 class="text-2xl font-bold neon-cyan mb-4">üõçÔ∏è Novo Produto Solto</h2>
                <form id="addProductForm" class="space-y-4" data-url="{{ url_for('admin.add_product') }}">
                    <input type="hidden" name="is_catalog" value="0">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="name" required placeholder="Nome" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white">
                        <input type="text" name="category" required placeholder="Categoria" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white">
                    </div>
                    <textarea name="description" required placeholder="Descri√ß√£o" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white"></textarea>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="number" name="sort_order" value="0" placeholder="Ordem" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white">
                        <input type="text" name="price" required placeholder="Pre√ßo" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white">
                    </div>
                    <input type="text" name="payment_url" placeholder="Link Mercado Pago" class="w-full px-4 py-2 bg-black border border-green-500 rounded text-white">
                    <input type="file" name="image" class="w-full px-4 py-2 bg-black border border-neon-cyan rounded text-white">
                    <button type="submit" class="w-full py-2 bg-neon-cyan text-black font-bold rounded hover:bg-opacity-80">Adicionar</button>
                </form>
                <div id="message" class="mt-4 hidden"></div>
            </div>
            </div>

        <div id="section-links" class="section-content hidden">
            <div class="mb-8 border-2 border-white rounded-lg p-8">
                <h2 class="text-2xl font-bold text-white mb-4">üîó Novo Link</h2>
                <form id="addLinkForm" class="space-y-4" data-url="{{ url_for('admin.add_link') }}" enctype="multipart/form-data">
                    <input type="text" name="title" required placeholder="T√≠tulo" class="w-full px-4 py-2 bg-black border border-white rounded text-white">
                    <input type="text" name="description" placeholder="Descri√ß√£o" class="w-full px-4 py-2 bg-black border border-white rounded text-white">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Imagem (opcional)</label>
                        <input type="file" name="image" accept="image/*" class="w-full px-4 py-2 bg-black border border-white rounded text-white text-sm">
                        <input type="text" name="image_url" placeholder="Ou URL da imagem" class="w-full mt-2 px-4 py-2 bg-black border border-white rounded text-white text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="download_link" placeholder="Link Download" class="w-full px-4 py-2 bg-black border border-white rounded text-white">
                        <input type="text" name="video_link" placeholder="Link V√≠deo" class="w-full px-4 py-2 bg-black border border-white rounded text-white">
                    </div>
                    <input type="text" name="game" placeholder="Jogo Relacionado" class="w-full px-4 py-2 bg-black border border-white rounded text-white">
                    <button type="submit" class="w-full py-2 bg-white text-black font-bold rounded hover:bg-gray-200">Adicionar Link</button>
                </form>
                <div id="link_message" class="mt-4 hidden"></div>
            </div>
            {% if links %}
            <div class="mt-8">
                <h3 class="text-lg font-bold text-white mb-4">Links cadastrados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for link in links %}
                    <div class="border border-white rounded-lg p-4 flex items-start gap-4">
                        {% if link.image %}
                        <img src="{{ link.image }}" alt="" class="w-16 h-16 object-cover rounded border border-gray-600 flex-shrink-0">
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-white truncate">{{ link.title }}</p>
                            {% if link.game %}<p class="text-xs text-gray-400">{{ link.game }}</p>{% endif %}
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick='openEditLink({{ link.id }}, {{ link.title|tojson }}, {{ (link.description or '')|tojson }}, {{ (link.image or '')|tojson }}, {{ (link.download_link or '')|tojson }}, {{ (link.video_link or '')|tojson }}, {{ (link.game or '')|tojson }})' class="text-xs px-2 py-1 bg-white text-black rounded hover:bg-gray-200">Editar</button>
                                <button type="button" onclick="deleteLink({{ link.id }})" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Remover</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            </div>
    </main>

    <div id="addSubproductModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 modal-hidden">
        <div class="m-auto w-full max-w-md max-h-[90vh] overflow-y-auto border-2 border-green-500 rounded-lg p-6 bg-black relative">
            <h3 class="text-xl font-bold text-green-500 mb-4">Adicionar Produto em <span id="sub_cat_name" class="text-white"></span></h3>
            <form id="addSubproductForm" class="space-y-3" data-url="{{ url_for('admin.add_product') }}">
                <input type="hidden" id="sub_pid" name="parent_id">
                <input type="hidden" name="is_catalog" value="0">
                <input type="text" name="name" required placeholder="Nome do Produto (ex: VIP 30 Dias)" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                <textarea name="description" required rows="2" placeholder="Descri√ß√£o" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white"></textarea>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" name="price" required placeholder="Pre√ßo (R$)" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                    <input type="number" name="sort_order" value="0" placeholder="Ordem" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                </div>
                <input type="text" name="category" required placeholder="Categoria (ex: Key)" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                <input type="text" name="payment_url" placeholder="Link Mercado Pago" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                <input type="file" name="image" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white">
                <div class="flex gap-2 mt-4">
                    <button type="button" onclick="closeModal('addSubproductModal')" class="flex-1 py-2 border border-red-500 text-red-500 rounded">Cancelar</button>
                    <button type="submit" class="flex-1 py-2 bg-green-600 text-black font-bold rounded">Salvar</button>
                </div>
            </form>
            <div id="subproduct_message" class="mt-2 hidden"></div>
        </div>
    </div>

    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 modal-hidden">
        <div class="m-auto w-full max-w-md max-h-[90vh] overflow-y-auto border-2 border-yellow-500 rounded-lg p-6 bg-black">
            <h3 class="text-xl font-bold text-yellow-500 mb-4">‚öôÔ∏è Configura√ß√µes</h3>
            <form id="configForm" class="space-y-4" data-url="{{ url_for('admin.update_config') }}">
                <div>
                    <label class="block text-sm text-gray-400">Chave Pix:</label>
                    <input type="text" name="pix_key" value="{{ config.pix_key if config else '' }}" class="w-full p-2 bg-gray-900 border border-yellow-500 rounded text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400">PIX Copia e Cola <span class="text-gray-500">(opcional ‚Äî para o QR Code funcionar ao escanear)</span>:</label>
                    <textarea name="pix_copia_cola" rows="3" placeholder="Cole aqui o c√≥digo PIX Copia e Cola do seu banco (c√≥digo longo que come√ßa com 00020126...)" class="w-full p-2 bg-gray-900 border border-yellow-500 rounded text-white text-sm">{{ config['pix_copia_cola'] if config and 'pix_copia_cola' in config.keys() and config['pix_copia_cola'] else '' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">Se vazio, o QR mostrar√° s√≥ a chave; muitos apps d√£o erro. Com o Copia e Cola, o cliente escaneia e paga direto.</p>
                </div>
                <div>
                    <label class="block text-sm text-gray-400">Carteira Binance:</label>
                    <input type="text" name="binance_wallet" value="{{ config.binance_wallet if config else '' }}" class="w-full p-2 bg-gray-900 border border-yellow-500 rounded text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-400">WhatsApp:</label>
                    <input type="text" name="whatsapp_number" value="{{ config.whatsapp_number if config else '' }}" class="w-full p-2 bg-gray-900 border border-yellow-500 rounded text-white">
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="closeModal('configModal')" class="flex-1 py-2 border border-red-500 text-red-500 rounded">Fechar</button>
                    <button type="submit" class="flex-1 py-2 bg-yellow-600 text-black font-bold rounded">Salvar</button>
                </div>
            </form>
            <div id="config_message" class="mt-2 hidden"></div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 modal-hidden">
        <div class="m-auto w-full max-w-md max-h-[90vh] overflow-y-auto border-2 border-blue-500 rounded-lg p-6 bg-black">
            <h3 class="text-xl font-bold text-blue-500 mb-4">Editar</h3>
            <form id="editProductForm" class="space-y-3">
                <input type="hidden" id="edit_id">
                <input type="hidden" id="edit_is_catalog" name="is_catalog">
                <input type="text" id="edit_name" name="name" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="Nome">
                <textarea id="edit_description" name="description" rows="2" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="Descri√ß√£o"></textarea>
                <input type="text" id="edit_price" name="price" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="Pre√ßo">
                <input type="text" id="edit_category" name="category" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="Categoria">
                <input type="text" id="edit_tagline" name="tagline" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="Tagline (ex: 30 dias de acesso)">
                <input type="text" id="edit_payment_url" name="payment_url" class="w-full p-2 bg-gray-900 border border-green-500 rounded text-white" placeholder="Link Mercado Pago">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Ordem/Posi√ß√£o (n√∫mero menor = aparece primeiro)</label>
                    <input type="number" id="edit_sort_order" name="sort_order" min="0" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white" placeholder="0">
                </div>
                <div id="edit_parent_div">
                    <label class="text-xs text-gray-400">Mover para:</label>
                    <select id="edit_parent_id" name="parent_id" class="w-full p-2 bg-gray-900 border border-blue-500 rounded text-white">
                        <option value="">Nenhum (Solto)</option>
                        {% for cat in parent_products %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="border border-blue-500 p-2 rounded">
                    <img id="edit_preview" src="" class="w-16 h-16 object-contain mb-2 border border-white">
                    <input type="file" id="edit_image" name="image" class="text-xs text-gray-400">
                    <input type="text" id="edit_image_url" name="image_url" placeholder="Ou URL da imagem" class="w-full mt-2 p-1 bg-gray-900 border border-blue-500 rounded text-white text-xs">
                </div>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('editModal')" class="flex-1 py-2 border border-red-500 text-red-500 rounded">Cancelar</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded">Salvar</button></div>
            </form>
            <div id="edit_message" class="mt-2 hidden"></div>
        </div>
    </div>

    <div id="editLinkModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 modal-hidden">
        <div class="m-auto w-full max-w-md max-h-[90vh] overflow-y-auto border-2 border-white rounded-lg p-6 bg-black">
            <h3 class="text-xl font-bold text-white mb-4">Editar Link</h3>
            <form id="editLinkForm" class="space-y-3" enctype="multipart/form-data">
                <input type="hidden" id="link_edit_id">
                <input type="text" id="link_title" name="title" class="w-full p-2 bg-gray-900 border border-white rounded text-white" placeholder="T√≠tulo">
                <input type="text" id="link_desc" name="description" class="w-full p-2 bg-gray-900 border border-white rounded text-white" placeholder="Descri√ß√£o">
                <div class="border border-white p-2 rounded">
                    <img id="link_edit_preview" src="" alt="" class="w-16 h-16 object-contain mb-2 border border-gray-600 rounded">
                    <input type="file" id="link_edit_image" name="image" accept="image/*" class="text-xs text-gray-400 w-full">
                    <input type="text" id="link_edit_image_url" name="image_url" placeholder="Ou URL da imagem" class="w-full mt-2 p-2 bg-gray-900 border border-white rounded text-white text-xs">
                </div>
                <input type="text" id="link_down" name="download_link" class="w-full p-2 bg-gray-900 border border-white rounded text-white" placeholder="Link Download">
                <input type="text" id="link_vid" name="video_link" class="w-full p-2 bg-gray-900 border border-white rounded text-white" placeholder="Link V√≠deo">
                <input type="text" id="link_game" name="game" class="w-full p-2 bg-gray-900 border border-white rounded text-white" placeholder="Jogo">
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal('editLinkModal')" class="flex-1 py-2 border border-red-500 text-red-500 rounded">Cancelar</button><button type="submit" class="flex-1 py-2 bg-white text-black font-bold rounded">Salvar</button></div>
            </form>
            <div id="link_edit_message" class="mt-2 hidden"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>
</html>